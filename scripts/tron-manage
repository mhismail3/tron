#!/usr/bin/env bash
#
# tron-manage - Unified Tron Management CLI
#
# Single entry point for all build, deploy, and development operations.
#
# Usage:
#   tron-manage <command> [options]
#
# Commands:
#   dev         Development operations (start, workspace, test)
#   build       Build for any tier (beta, prod, public)
#   deploy      Deploy and manage installations
#   server      Server management (start, stop, status)
#   release     Create a release for distribution
#   help        Show this help
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

VERSION="0.1.0"

show_banner() {
    echo ""
    echo -e "${CYAN}████████╗██████╗  ██████╗ ███╗   ██╗${NC}"
    echo -e "${CYAN}╚══██╔══╝██╔══██╗██╔═══██╗████╗  ██║${NC}"
    echo -e "${CYAN}   ██║   ██████╔╝██║   ██║██╔██╗ ██║${NC}"
    echo -e "${CYAN}   ██║   ██╔══██╗██║   ██║██║╚██╗██║${NC}"
    echo -e "${CYAN}   ██║   ██║  ██║╚██████╔╝██║ ╚████║${NC}"
    echo -e "${CYAN}   ╚═╝   ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝${NC}"
    echo -e "${DIM}       Management CLI v$VERSION${NC}"
    echo ""
}

show_help() {
    show_banner
    echo -e "${BOLD}USAGE${NC}"
    echo "  tron-manage <command> [options]"
    echo ""
    echo -e "${BOLD}COMMANDS${NC}"
    echo ""
    echo -e "  ${GREEN}Development${NC}"
    echo "    dev                   Start development server"
    echo "    dev workspace <name>  Create/switch workspace"
    echo "    dev list              List workspaces"
    echo "    dev test              Run tests in watch mode"
    echo "    dev typecheck         Run type checking"
    echo ""
    echo -e "  ${GREEN}Building${NC}"
    echo "    build                 Build beta (development)"
    echo "    build prod            Build production"
    echo "    build public          Build for public release"
    echo "    build --clean         Clean before build"
    echo ""
    echo -e "  ${GREEN}Deployment${NC}"
    echo "    deploy                Deploy prod tier"
    echo "    deploy prod           Deploy personal production"
    echo "    deploy public         Deploy public release"
    echo "    deploy uninstall      Remove installation"
    echo "    deploy status         Show deployment status"
    echo ""
    echo -e "  ${GREEN}Server${NC}"
    echo "    server start          Start the server"
    echo "    server stop           Stop the server"
    echo "    server restart        Restart the server"
    echo "    server status         Show server status"
    echo "    server logs           Tail server logs"
    echo ""
    echo -e "  ${GREEN}Release${NC}"
    echo "    release               Create release tarball"
    echo "    release --homebrew    Generate Homebrew formula"
    echo ""
    echo -e "  ${GREEN}Other${NC}"
    echo "    setup                 Initial project setup"
    echo "    help                  Show this help"
    echo "    version               Show version"
    echo ""
    echo -e "${BOLD}EXAMPLES${NC}"
    echo ""
    echo "  # Start development"
    echo "  tron-manage dev"
    echo ""
    echo "  # Create a feature workspace"
    echo "  tron-manage dev workspace feature-x"
    echo ""
    echo "  # Build and deploy production"
    echo "  tron-manage deploy prod"
    echo ""
    echo "  # Check server status"
    echo "  tron-manage server status"
    echo ""
    echo -e "${BOLD}TIERS${NC}"
    echo ""
    echo "  ${YELLOW}beta${NC}    Development builds with hot-reload and debugging"
    echo "  ${YELLOW}prod${NC}    Personal production with all features"
    echo "  ${YELLOW}public${NC}  Public release with stable features only"
    echo ""
}

# Dispatch to scripts
dispatch_dev() {
    exec "$SCRIPT_DIR/dev.sh" "$@"
}

dispatch_build() {
    exec "$SCRIPT_DIR/build.sh" "$@"
}

dispatch_deploy() {
    exec "$SCRIPT_DIR/deploy.sh" "$@"
}

dispatch_server() {
    local cmd="${1:-status}"
    shift || true

    case "$cmd" in
        start|stop|restart|status|logs)
            exec "$SCRIPT_DIR/deploy.sh" prod "$cmd"
            ;;
        *)
            echo -e "${RED}Unknown server command: $cmd${NC}"
            echo "Available: start, stop, restart, status, logs"
            exit 1
            ;;
    esac
}

dispatch_release() {
    local homebrew=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            --homebrew)
                homebrew=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Build public release
    "$SCRIPT_DIR/build.sh" public

    if [ "$homebrew" = true ]; then
        generate_homebrew_formula
    fi
}

generate_homebrew_formula() {
    local version
    version=$(node -p "require('$PROJECT_DIR/package.json').version")
    local tarball="$PROJECT_DIR/releases/tron-$version.tar.gz"
    local sha256_file="$PROJECT_DIR/releases/tron-$version.sha256"

    if [ ! -f "$tarball" ]; then
        echo -e "${RED}Release tarball not found. Run 'tron-manage release' first.${NC}"
        exit 1
    fi

    local sha256
    sha256=$(cat "$sha256_file")

    local formula_dir="$PROJECT_DIR/releases/homebrew"
    mkdir -p "$formula_dir"

    cat > "$formula_dir/tron.rb" << EOF
class Tron < Formula
  desc "Persistent, dual-interface coding agent with memory-first architecture"
  homepage "https://github.com/yourusername/tron"
  url "https://github.com/yourusername/tron/releases/download/v$version/tron-$version.tar.gz"
  sha256 "$sha256"
  license "MIT"

  depends_on "node@20"

  def install
    # Install npm packages
    system "npm", "install", "--production", "--ignore-scripts"

    # Install binaries
    libexec.install Dir["*"]
    (bin/"tron").write_env_script libexec/"packages/tui/dist/cli.js",
      TRON_BUILD_TIER: "public",
      TRON_PUBLIC: "1",
      NODE_ENV: "production"
  end

  def post_install
    # Create data directory
    (var/"tron").mkpath
  end

  service do
    run [opt_bin/"tron", "--server"]
    keep_alive true
    log_path var/"log/tron.log"
    error_log_path var/"log/tron.log"
  end

  test do
    assert_match "tron v$version", shell_output("#{bin}/tron --version")
  end
end
EOF

    echo ""
    echo -e "${GREEN}✓${NC} Generated Homebrew formula: $formula_dir/tron.rb"
    echo ""
}

dispatch_setup() {
    exec "$SCRIPT_DIR/setup.sh" "$@"
}

# Main
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift || true

case "$COMMAND" in
    dev)
        dispatch_dev "$@"
        ;;
    build)
        dispatch_build "$@"
        ;;
    deploy)
        dispatch_deploy "$@"
        ;;
    server)
        dispatch_server "$@"
        ;;
    release)
        dispatch_release "$@"
        ;;
    setup)
        dispatch_setup "$@"
        ;;
    help|-h|--help)
        show_help
        ;;
    version|-v|--version)
        echo "tron-manage v$VERSION"
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        echo "Run 'tron-manage help' for usage."
        exit 1
        ;;
esac
