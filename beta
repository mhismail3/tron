#!/bin/bash
# Run beta server from this workspace
# Usage: ./beta

set -e

# Ensure bun is in PATH
export PATH="$HOME/.bun/bin:$PATH"

# Get project root (where this script lives)
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$PROJECT_DIR"

# Config
BETA_WS_PORT=8082
BETA_HEALTH_PORT=8083
TRON_HOME="${TRON_DATA_DIR:-$HOME/.tron}"

# Colors
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# Check if beta port is already in use
if lsof -i :$BETA_WS_PORT -sTCP:LISTEN >/dev/null 2>&1; then
    echo -e "${YELLOW}Beta server already running on port $BETA_WS_PORT${NC}"
    echo "  Kill it first: kill \$(lsof -t -i :$BETA_WS_PORT)"
    exit 1
fi

# Check better-sqlite3 native module compatibility
check_native_module() {
    # Test from packages/core where better-sqlite3 is actually installed
    (cd packages/core && node -e "require('better-sqlite3')" 2>&1) | grep -q "NODE_MODULE_VERSION" && return 1
    (cd packages/core && node -e "require('better-sqlite3')" 2>/dev/null)
    return $?
}

rebuild_native_module() {
    echo -e "${YELLOW}Rebuilding better-sqlite3 native module...${NC}"

    SQLITE_DIR="node_modules/.bun/better-sqlite3@11.10.0/node_modules/better-sqlite3"

    if [ ! -d "$SQLITE_DIR" ]; then
        # Module not installed, do full install
        echo "  Module not found, running bun install..."
        PYTHON=/opt/homebrew/bin/python3 bun install
    else
        # Rebuild just the native module
        echo "  Cleaning build directory..."
        rm -rf "$SQLITE_DIR/build"

        echo "  Running node-gyp rebuild..."
        (cd "$SQLITE_DIR" && PYTHON=/opt/homebrew/bin/python3 npx node-gyp rebuild --release)
    fi

    # Verify it works now
    if check_native_module; then
        echo -e "${GREEN}  Native module rebuilt successfully${NC}"
        return 0
    else
        echo -e "${RED}  Rebuild failed, trying full reinstall...${NC}"
        rm -rf node_modules
        PYTHON=/opt/homebrew/bin/python3 bun install
        bun run build
        return $?
    fi
}

# Check native module compatibility
if ! check_native_module; then
    echo -e "${YELLOW}Native module version mismatch detected${NC}"
    rebuild_native_module
fi

# Build if needed
if [ ! -d "packages/server/dist" ]; then
    echo "Building..."
    bun run build
fi

echo ""
echo -e "${CYAN}Starting Beta Server${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  WebSocket: ws://localhost:$BETA_WS_PORT/ws"
echo "  Health:    http://localhost:$BETA_HEALTH_PORT/health"
echo "  Database:  $TRON_HOME/db/beta.db"
echo "  Workspace: $PROJECT_DIR"
echo ""
echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Run with beta environment
export TRON_WS_PORT=$BETA_WS_PORT
export TRON_HEALTH_PORT=$BETA_HEALTH_PORT
export TRON_BUILD_TIER=beta
export TRON_EVENT_STORE_DB="$TRON_HOME/db/beta.db"
export LOG_LEVEL="${LOG_LEVEL:-trace}"
export NODE_ENV=development

exec node packages/server/dist/index.js
