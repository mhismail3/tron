#!/bin/bash
# Deploy to production from this workspace
# Usage: ./prod [deploy|install|rollback]

set -e

# Get project root (where this script lives)
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
SCRIPT_DIR="$PROJECT_DIR/scripts"
cd "$PROJECT_DIR"

# Config
TRON_HOME="${TRON_DATA_DIR:-$HOME/.tron}"
INSTALL_DIR="$TRON_HOME/app"
PLIST_NAME="com.tron.server"
PLIST_PATH="$HOME/Library/LaunchAgents/$PLIST_NAME.plist"
DEPLOYED_COMMIT_FILE="$INSTALL_DIR/deployed-commit"
PROD_WS_PORT=8080
PROD_HEALTH_PORT=8081
PROD_LOG_FILE="$INSTALL_DIR/server.log"
BIN_DIR="$HOME/.local/bin"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_status() { echo -e "${BLUE}▸${NC} $1"; }
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_warning() { echo -e "${YELLOW}!${NC} $1"; }

is_running() { launchctl list 2>/dev/null | grep -q "$PLIST_NAME"; }
get_pid() { lsof -t -i :$PROD_WS_PORT -sTCP:LISTEN 2>/dev/null || true; }

cmd_deploy() {
    echo ""
    echo -e "${CYAN}Deploying to Production${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Workspace: $PROJECT_DIR"
    echo ""

    # Check if installed
    if [ ! -f "$PLIST_PATH" ]; then
        print_error "Tron not installed. Run: ./prod install"
        exit 1
    fi

    # Check for uncommitted changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        print_warning "You have uncommitted changes!"
        echo ""
        git status --short
        echo ""
        read -p "Deploy anyway? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_error "Aborted. Commit your changes first."
            exit 1
        fi
    fi

    # Run tests first
    print_status "Running tests..."
    if ! bun run test 2>&1; then
        print_error "Tests failed! Aborting deploy."
        exit 1
    fi
    print_success "Tests passed"

    # Build production bundle
    print_status "Building production bundle..."
    if ! "$SCRIPT_DIR/build-prod.sh" 2>&1; then
        print_error "Build failed! Aborting deploy."
        exit 1
    fi
    print_success "Build complete"

    # Stop service if running
    if is_running; then
        print_status "Stopping production service..."
        launchctl unload "$PLIST_PATH" 2>/dev/null || true
        sleep 1
    fi

    # Copy production bundle to install directory
    print_status "Installing to $INSTALL_DIR..."
    rm -rf "$INSTALL_DIR"/*
    cp -r "$PROJECT_DIR/dist/prod/"* "$INSTALL_DIR/"
    print_success "Installed to: $INSTALL_DIR"

    # Record deployed commit
    current_commit=$(git rev-parse HEAD)
    echo "$current_commit" > "$DEPLOYED_COMMIT_FILE"
    print_success "Recorded deploy: ${current_commit:0:7}"

    # Start service
    print_status "Starting production service..."
    launchctl load "$PLIST_PATH"
    sleep 3

    if is_running; then
        pid=$(get_pid)
        print_success "Production service started (PID: ${pid:-unknown})"
    else
        print_error "Failed to start service. Check: tron logs"
        exit 1
    fi

    echo ""
    print_success "Deploy complete!"
    echo ""
}

cmd_install() {
    echo ""
    echo -e "${CYAN}Installing Tron Service${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Workspace: $PROJECT_DIR"
    echo ""

    # Ensure directories exist
    mkdir -p "$BIN_DIR"
    mkdir -p "$TRON_HOME"
    mkdir -p "$INSTALL_DIR"
    mkdir -p "$HOME/Library/LaunchAgents"

    # Build production bundle if needed
    if [ ! -f "$PROJECT_DIR/dist/prod/index.js" ]; then
        print_status "Building production bundle..."
        "$SCRIPT_DIR/build-prod.sh"
    fi

    # Copy production bundle to install directory
    print_status "Installing to $INSTALL_DIR..."
    rm -rf "$INSTALL_DIR"/*
    cp -r "$PROJECT_DIR/dist/prod/"* "$INSTALL_DIR/"
    print_success "Installed to: $INSTALL_DIR"

    # Get node path
    node_path=$(which node)

    # Create launchd plist
    print_status "Creating launchd service..."
    cat > "$PLIST_PATH" << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>$PLIST_NAME</string>

    <key>ProgramArguments</key>
    <array>
        <string>/bin/sh</string>
        <string>-c</string>
        <string>exec "$node_path" "$INSTALL_DIR/index.js" >> "$PROD_LOG_FILE" 2>&amp;1</string>
    </array>

    <key>WorkingDirectory</key>
    <string>$INSTALL_DIR</string>

    <key>RunAtLoad</key>
    <true/>

    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
        <key>Crashed</key>
        <true/>
    </dict>

    <key>ThrottleInterval</key>
    <integer>10</integer>

    <key>EnvironmentVariables</key>
    <dict>
        <key>NODE_ENV</key>
        <string>production</string>
        <key>TRON_BUILD_TIER</key>
        <string>prod</string>
        <key>HOME</key>
        <string>$HOME</string>
        <key>PATH</key>
        <string>$(dirname "$node_path"):/usr/local/bin:/usr/bin:/bin</string>
        <key>TRON_DATA_DIR</key>
        <string>$TRON_HOME</string>
        <key>TRON_WS_PORT</key>
        <string>$PROD_WS_PORT</string>
        <key>TRON_HEALTH_PORT</key>
        <string>$PROD_HEALTH_PORT</string>
        <key>LOG_LEVEL</key>
        <string>info</string>
    </dict>

    <key>SoftResourceLimits</key>
    <dict>
        <key>NumberOfFiles</key>
        <integer>4096</integer>
    </dict>
</dict>
</plist>
PLIST
    print_success "Created: $PLIST_PATH"

    # Install CLI symlink (points back to this workspace)
    print_status "Installing tron CLI..."
    ln -sf "$SCRIPT_DIR/tron" "$BIN_DIR/tron"
    print_success "Installed: $BIN_DIR/tron -> $SCRIPT_DIR/tron"

    # Check if ~/.local/bin is in PATH
    if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
        print_warning "Add to your shell profile: export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi

    # Record initial deploy
    current_commit=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
    echo "$current_commit" > "$DEPLOYED_COMMIT_FILE"

    # Start the service
    print_status "Starting service..."
    launchctl load "$PLIST_PATH"
    sleep 3

    if is_running; then
        pid=$(get_pid)
        print_success "Service started! (PID: ${pid:-unknown})"
    else
        print_error "Service failed to start. Check: tron logs"
    fi

    echo ""
    print_success "Installation complete!"
    echo ""
    echo "Locations:"
    echo "  App:   $INSTALL_DIR"
    echo "  Data:  $TRON_HOME"
    echo ""
    echo "Commands:"
    echo "  tron status  - Check service status"
    echo "  tron logs    - Query logs from database"
    echo "  ./beta       - Run beta server"
    echo "  ./prod       - Deploy to production"
    echo ""
}

cmd_rollback() {
    echo ""
    echo -e "${CYAN}Rolling Back to Last Deployed State${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Check if we have a deployed commit recorded
    if [ ! -f "$DEPLOYED_COMMIT_FILE" ]; then
        print_error "No deployed commit found. Cannot rollback."
        echo "  Run './prod deploy' first to record a deployment."
        exit 1
    fi

    deployed_commit=$(cat "$DEPLOYED_COMMIT_FILE")
    deployed_msg=$(git log -1 --format="%s" "$deployed_commit" 2>/dev/null | head -c 60)
    current_commit=$(git rev-parse HEAD)

    # Check if we're already at the deployed commit
    if [ "$current_commit" = "$deployed_commit" ]; then
        print_success "Already at deployed commit: ${deployed_commit:0:7}"
        exit 0
    fi

    echo "  Current:  ${current_commit:0:7} - $(git log -1 --format='%s' HEAD | head -c 50)"
    echo "  Deployed: ${deployed_commit:0:7} - $deployed_msg"
    echo ""

    # Check for uncommitted changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        print_warning "You have uncommitted changes that will be stashed!"
        echo ""
        git status --short
        echo ""
    fi

    read -p "Reset working directory to deployed commit? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_error "Aborted."
        exit 1
    fi

    # Stash any changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        print_status "Stashing uncommitted changes..."
        git stash push -m "Auto-stash before rollback to $deployed_commit"
    fi

    # Reset to deployed commit
    print_status "Resetting to ${deployed_commit:0:7}..."
    git checkout "$deployed_commit" -- .
    git reset HEAD
    print_success "Working directory restored"

    # Build and redeploy
    print_status "Building production bundle..."
    "$SCRIPT_DIR/build-prod.sh"
    print_success "Build complete"

    print_status "Redeploying..."
    if is_running; then
        launchctl unload "$PLIST_PATH" 2>/dev/null || true
        sleep 1
    fi

    rm -rf "$INSTALL_DIR"/*
    cp -r "$PROJECT_DIR/dist/prod/"* "$INSTALL_DIR/"
    echo "$deployed_commit" > "$DEPLOYED_COMMIT_FILE"

    if [ -f "$PLIST_PATH" ]; then
        launchctl load "$PLIST_PATH"
        sleep 3
        if is_running; then
            print_success "Production service restarted"
        else
            print_error "Failed to restart service"
        fi
    fi

    echo ""
    print_success "Rollback complete! Now at: ${deployed_commit:0:7}"
    echo ""
}

cmd_help() {
    echo "Usage: ./prod <command>"
    echo ""
    echo "Commands:"
    echo "  deploy    Deploy current workspace to production"
    echo "  install   Initial setup (launchd service, CLI)"
    echo "  rollback  Restore to last deployed commit"
    echo ""
}

case "${1:-deploy}" in
    deploy)   cmd_deploy ;;
    install)  cmd_install ;;
    rollback) cmd_rollback ;;
    help|-h|--help) cmd_help ;;
    *)
        echo "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
